<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Be My Code - G√∂rme Engelliler ƒ∞√ßin Python IDE</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    
    <style>
        .CodeMirror {
            background-color: #1A181B !important;
            color: #EEECEE !important;
            border-radius: 0.5rem;
            min-height: 400px;
            font-size: 18px;
            line-height: 1.8;
            font-family: 'Consolas', monospace;
        }
        
        .CodeMirror-cursor {
            border-left: 3px solid #D7BB56 !important;
        }
        
        .voice-active {
            animation: pulse 1s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(215, 187, 86, 0.8);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4">

    <!-- Header -->
    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-yellow-400">üé§ Be My Code - Sesli Python IDE</h1>
        <p class="text-gray-400 mt-2">Ctrl+M veya Cmd+M ile mikrofonu a√ß/kapa</p>
        <div id="status" class="mt-4 text-xl font-bold" aria-live="polite">Y√ºkleniyor...</div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
        
        <!-- Python Editor -->
        <section class="bg-gray-800 p-4 rounded-lg">
            <h2 class="text-xl font-bold mb-3 text-yellow-400">Python Edit√∂r</h2>
            <textarea id="codeEditor" aria-label="Python kod edit√∂r√º"></textarea>
        </section>

        <!-- Terminal Output -->
        <section class="bg-gray-800 p-4 rounded-lg">
            <h2 class="text-xl font-bold mb-3 text-yellow-400">Terminal √áƒ±ktƒ±sƒ±</h2>
            <div id="terminal" 
                 class="bg-black text-green-400 p-4 rounded h-96 overflow-y-auto font-mono text-sm"
                 aria-live="polite"
                 aria-label="Terminal √ßƒ±ktƒ±sƒ±">
                >>> Be My Code Terminal Hazƒ±r
            </div>
        </section>

    </main>

    <!-- Floating Voice Button (Always Visible) -->
    <button id="voiceBtn" 
            class="fixed bottom-8 right-8 w-20 h-20 bg-yellow-500 hover:bg-yellow-600 rounded-full shadow-2xl flex items-center justify-center text-4xl focus:outline-none focus:ring-4 focus:ring-yellow-300"
            aria-label="Sesli komut butonu - Ctrl+M ile a√ß/kapa">
        üé§
    </button>

    <script>
        // ==========================================
        // KONFIG√úRASYON
        // ==========================================
        const CONFIG = {
            GEMINI_API_KEY: "AIzaSyCMAcbLrhsR8EqUfOgr7SmKTvPTeQU0ZkQ",
            TEXT_MODEL: 'gemini-2.5-flash-preview-09-2025',
            TTS_MODEL: 'gemini-2.5-flash-preview-tts',
            VOICE_NAME: 'Kore'
        };

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        const state = {
            editor: null,
            recognition: null,
            isListening: false,
            lastSpoken: '',
            audioQueue: [] // Ses kuyruƒüu
        };

        const elements = {
            status: document.getElementById('status'),
            terminal: document.getElementById('terminal'),
            voiceBtn: document.getElementById('voiceBtn')
        };

        // ==========================================
        // SES Sƒ∞STEMƒ∞ (Web Speech API + TTS)
        // ==========================================
        const VoiceSystem = {
            // Kullanƒ±cƒ± konu≈ümasƒ±nƒ± dinle
            startListening() {
                if (!state.recognition) {
                    this.speak('Ses tanƒ±ma sistemi hazƒ±r deƒüil.');
                    return;
                }
                
                state.recognition.start();
                state.isListening = true;
                elements.voiceBtn.classList.add('voice-active');
                elements.status.textContent = 'üé§ Dƒ∞NLƒ∞YORUM - ≈ûimdi konu≈üun';
                
                // Bip sesi
                const beep = new AudioContext();
                const osc = beep.createOscillator();
                const gain = beep.createGain();
                osc.connect(gain);
                gain.connect(beep.destination);
                osc.frequency.value = 800;
                gain.gain.value = 0.3;
                osc.start();
                osc.stop(beep.currentTime + 0.1);
            },

            stopListening() {
                if (state.recognition) {
                    state.recognition.stop();
                }
                state.isListening = false;
                elements.voiceBtn.classList.remove('voice-active');
                elements.status.textContent = '‚è∏Ô∏è DURAKLATILDI - Ctrl+M ile tekrar ba≈ülat';
            },

            toggle() {
                if (state.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            },

            // Gemini TTS ile konu≈ü
            async speak(text) {
                if (!text) return;
                
                console.log('üîä Konu≈üuyor:', text);
                elements.status.textContent = 'üîä ' + text;
                
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.TTS_MODEL}:generateContent?key=${CONFIG.GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: {
                                        voiceConfig: {
                                            prebuiltVoiceConfig: { voiceName: CONFIG.VOICE_NAME }
                                        }
                                    }
                                }
                            })
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (audioData) {
                        await this.playAudio(audioData);
                    }
                } catch (error) {
                    console.error('TTS Hatasƒ±:', error);
                    elements.status.textContent = '‚ö†Ô∏è Ses hatasƒ±: ' + error.message;
                }
            },

            async playAudio(base64Audio) {
                const binary = atob(base64Audio);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                
                const pcm16 = new Int16Array(bytes.buffer);
                const wavBlob = this.pcmToWav(pcm16, 24000);
                const url = URL.createObjectURL(wavBlob);
                const audio = new Audio(url);
                
                return new Promise((resolve) => {
                    audio.onended = () => {
                        URL.revokeObjectURL(url);
                        resolve();
                    };
                    audio.play();
                });
            },

            pcmToWav(pcm16, sampleRate) {
                const buffer = new ArrayBuffer(44 + pcm16.length * 2);
                const view = new DataView(buffer);
                
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + pcm16.length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, pcm16.length * 2, true);
                
                const pcmBytes = new Int16Array(buffer, 44);
                pcmBytes.set(pcm16);
                
                return new Blob([buffer], { type: 'audio/wav' });
            },

            setupRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    this.speak('Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor. Chrome kullanƒ±n.');
                    return false;
                }

                state.recognition = new webkitSpeechRecognition();
                state.recognition.continuous = false;
                state.recognition.interimResults = false;
                state.recognition.lang = 'tr-TR';

                state.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    console.log('üëÇ Duyulan:', transcript);
                    
                    this.speak(`Anla≈üƒ±ldƒ±: ${transcript}`);
                    CommandHandler.process(transcript);
                };

                state.recognition.onerror = (event) => {
                    console.error('Ses tanƒ±ma hatasƒ±:', event.error);
                    state.isListening = false;
                    elements.voiceBtn.classList.remove('voice-active');
                    
                    if (event.error === 'no-speech') {
                        this.speak('Ses algƒ±lanamadƒ±. Tekrar deneyin.');
                    } else if (event.error === 'not-allowed') {
                        this.speak('Mikrofon izni reddedildi.');
                    }
                };

                state.recognition.onend = () => {
                    state.isListening = false;
                    elements.voiceBtn.classList.remove('voice-active');
                    elements.status.textContent = '‚úÖ Hazƒ±r - Ctrl+M ile komut ver';
                };

                return true;
            }
        };

        // ==========================================
        // KOMUT ƒ∞≈ûLEYƒ∞Cƒ∞
        // ==========================================
        const CommandHandler = {
            async process(command) {
                console.log('‚öôÔ∏è Komut i≈üleniyor:', command);

                // Kod √ßalƒ±≈ütƒ±rma
                if (command.includes('√ßalƒ±≈ütƒ±r') || command.includes('run')) {
                    await this.runCode();
                }
                // Kodu oku
                else if (command.includes('kodu oku') || command.includes('oku')) {
                    await this.readCode();
                }
                // Terminal oku
                else if (command.includes('terminal') || command.includes('√ßƒ±ktƒ±')) {
                    await this.readTerminal();
                }
                // Edit√∂r√º temizle
                else if (command.includes('temizle') || command.includes('sil')) {
                    await this.clearEditor();
                }
                // Kod √ºret
                else {
                    await this.generateCode(command);
                }
            },

            async runCode() {
                VoiceSystem.speak('Kod √ßalƒ±≈ütƒ±rƒ±lƒ±yor');
                const code = state.editor.getValue();
                
                if (!code.trim()) {
                    VoiceSystem.speak('Edit√∂r bo≈ü. √ñnce kod yazƒ±n.');
                    return;
                }

                try {
                    // Basit Python sim√ºlasyonu
                    const printMatches = code.matchAll(/print\s*\((.*?)\)/gs);
                    let output = '>>> Sim√ºlasyon Ba≈üladƒ±\n';
                    
                    for (const match of printMatches) {
                        let content = match[1].trim().replace(/['"]/g, '');
                        output += content + '\n';
                    }
                    
                    output += '>>> Tamamlandƒ±';
                    elements.terminal.textContent = output;
                    
                    VoiceSystem.speak('Kod ba≈üarƒ±yla √ßalƒ±≈ütƒ±. ' + output.replace(/>>>/g, ''));
                } catch (error) {
                    elements.terminal.textContent = 'HATA: ' + error.message;
                    VoiceSystem.speak('Kod √ßalƒ±≈ütƒ±rma hatasƒ±: ' + error.message);
                }
            },

            async readCode() {
                const code = state.editor.getValue();
                if (!code.trim()) {
                    VoiceSystem.speak('Edit√∂r bo≈ü.');
                    return;
                }
                
                VoiceSystem.speak('Kodu okuyorum. ' + code);
            },

            async readTerminal() {
                const output = elements.terminal.textContent;
                if (!output.trim() || output.includes('Hazƒ±r')) {
                    VoiceSystem.speak('Terminal bo≈ü.');
                    return;
                }
                
                VoiceSystem.speak('Terminal √ßƒ±ktƒ±sƒ±: ' + output);
            },

            async clearEditor() {
                state.editor.setValue('');
                elements.terminal.textContent = '>>> Terminal temizlendi';
                VoiceSystem.speak('Edit√∂r temizlendi.');
            },

            async generateCode(prompt) {
                VoiceSystem.speak('Kod √ºretiliyor');
                elements.status.textContent = '‚è≥ Kod √ºretiliyor...';

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.TEXT_MODEL}:generateContent?key=${CONFIG.GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `Sen bir Python kod asistanƒ±sƒ±n. SADECE Python kodu d√∂nd√ºr, a√ßƒ±klama yazma.\n\nƒ∞stek: ${prompt}\n\nKod:`
                                    }]
                                }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 500
                                }
                            })
                        }
                    );

                    const result = await response.json();
                    let code = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    
                    // Kod bloklarƒ±nƒ± temizle
                    code = code.replace(/```python\n?/g, '').replace(/```\n?/g, '').trim();
                    
                    if (code) {
                        const currentCode = state.editor.getValue();
                        state.editor.setValue(currentCode ? currentCode + '\n\n' + code : code);
                        VoiceSystem.speak('Kod eklendi.');
                    } else {
                        VoiceSystem.speak('Kod √ºretilemedi.');
                    }
                } catch (error) {
                    console.error('Kod √ºretme hatasƒ±:', error);
                    VoiceSystem.speak('Kod √ºretme hatasƒ±: ' + error.message);
                }
            }
        };

        // ==========================================
        // BA≈ûLATMA
        // ==========================================
        async function init() {
            // CodeMirror ba≈ülat
            state.editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                lineNumbers: true,
                mode: "python",
                theme: "monokai",
                indentUnit: 4,
                tabSize: 4
            });
            state.editor.setValue('# Sesli komut i√ßin Ctrl+M veya Cmd+M basƒ±n\nprint("Merhaba D√ºnya")');

            // Ses tanƒ±ma sistemi
            const voiceReady = VoiceSystem.setupRecognition();
            
            if (voiceReady) {
                elements.status.textContent = '‚úÖ Hazƒ±r - Ctrl+M ile ba≈ülat';
                
                // Ho≈ü geldin mesajƒ±
                setTimeout(() => {
                    VoiceSystem.speak('Be My Code IDE hazƒ±r. Ctrl M veya Cmd M ile mikrofonu a√ßƒ±n.');
                }, 1000);
            } else {
                elements.status.textContent = '‚ùå Ses tanƒ±ma desteklenmiyor';
            }

            // Klavye kƒ±sayolu
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                    e.preventDefault();
                    VoiceSystem.toggle();
                }
            });

            // Buton tƒ±klama
            elements.voiceBtn.addEventListener('click', () => {
                VoiceSystem.toggle();
            });
        }

        // Sayfa y√ºklendiƒüinde ba≈ülat
        window.addEventListener('load', init);
    </script>

</body>
</html>
