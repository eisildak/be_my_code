<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Be My Code - Sesli Python IDE</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    
    <style>
        :root {
            --dark-bg: #1A181B;
            --accent-gold: #D7BB56;
            --text-light: #EEECEE;
            --gray-900: #111827;
        }

        /* CodeMirror Ã–zelleÅŸtirme */
        .CodeMirror {
            background-color: var(--dark-bg) !important;
            color: var(--text-light) !important;
            border-radius: 0.5rem;
            min-height: 400px;
            font-size: 16px;
            line-height: 1.6;
            font-family: 'Fira Code', 'Consolas', monospace;
        }
        
        .CodeMirror-gutters {
            background-color: var(--dark-bg) !important;
            border-right: 1px solid #333;
        }
        
        .CodeMirror-linenumber {
            color: #666 !important;
        }
        
        .CodeMirror-cursor {
            border-left: 2px solid var(--accent-gold) !important;
        }

        /* Tema Renkleri */
        .accent-color {
            color: var(--accent-gold);
        }
        
        .bg-accent {
            background-color: var(--accent-gold);
        }

        /* Mikrofon Butonu AnimasyonlarÄ± */
        .voice-btn {
            transition: all 0.3s ease;
        }
        
        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(215, 187, 86, 0.6);
        }
        
        .voice-btn.listening {
            animation: pulse-grow 1.2s ease-in-out infinite;
        }

        @keyframes pulse-grow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(215, 187, 86, 0.5);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 0 30px rgba(215, 187, 86, 1);
            }
        }

        /* Terminal Ã‡Ä±ktÄ± Stili */
        #terminalOutput {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .CodeMirror {
                min-height: 300px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <!-- Ana Konteyner -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        
        <!-- BaÅŸlÄ±k BÃ¶lÃ¼mÃ¼ -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-2">
                <span class="accent-color">Be My Code</span>
            </h1>
            <p class="text-gray-400 text-lg">
                GÃ¶rme Engelli Bireyler Ä°Ã§in Gemini AI Destekli Python IDE
            </p>
        </header>

        <!-- Kod EditÃ¶r BÃ¶lÃ¼mÃ¼ -->
        <section class="mb-6">
            <div class="bg-[#1A181B] rounded-xl shadow-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold accent-color flex items-center gap-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Python EditÃ¶r
                    </h2>
                    <button id="runCodeBtn" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-5 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Ã‡alÄ±ÅŸtÄ±r
                    </button>
                </div>
                <textarea id="codeEditor" class="hidden"></textarea>
            </div>
        </section>

        <!-- Sesli Komut Kontrol Paneli -->
        <section class="mb-6">
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex flex-col items-center space-y-5">
                    
                    <!-- Mikrofon Butonu -->
                    <button id="voiceCommandBtn" class="voice-btn w-24 h-24 rounded-full bg-accent text-gray-900 flex items-center justify-center shadow-2xl focus:outline-none focus:ring-4 focus:ring-[#D7BB56]/60" aria-label="Sesli komut">
                        <svg id="micIcon" class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
                        </svg>
                        <svg id="loaderIcon" class="w-12 h-12 animate-spin hidden" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>

                    <!-- Durum MesajlarÄ± -->
                    <div class="text-center space-y-2">
                        <p id="statusMessage" class="text-lg font-medium text-gray-300">
                            BaÅŸlamak iÃ§in mikrofona tÄ±klayÄ±n (Ctrl+M)
                        </p>
                        <p id="ttsStatus" class="text-sm text-gray-500">
                            Sesli geri bildirim hazÄ±r
                        </p>
                    </div>
                    
                    <!-- HÄ±zlÄ± Komut ButonlarÄ± -->
                    <div class="flex flex-wrap justify-center gap-3 pt-3">
                        <button onclick="App.simulateCommand('for dÃ¶ngÃ¼sÃ¼ yaz')" class="quick-cmd-btn">
                            For DÃ¶ngÃ¼sÃ¼
                        </button>
                        <button onclick="App.simulateCommand('string deÄŸiÅŸken tanÄ±mla isim')" class="quick-cmd-btn">
                            String DeÄŸiÅŸken
                        </button>
                        <button onclick="App.simulateCommand('print fonksiyonu yaz Merhaba DÃ¼nya')" class="quick-cmd-btn">
                            Print Yaz
                        </button>
                        <button onclick="App.simulateCommand('kodu sesli oku')" class="quick-cmd-btn">
                            Kodu Oku
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Terminal Ã‡Ä±ktÄ± BÃ¶lÃ¼mÃ¼ -->
        <section>
            <div class="bg-[#1A181B] rounded-xl shadow-2xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                    </svg>
                    <h2 class="text-2xl font-semibold text-red-400">Terminal</h2>
                </div>
                <pre id="terminalOutput" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto min-h-[120px] max-h-[400px]">Uygulama baÅŸlatÄ±ldÄ±. Kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in 'Ã‡alÄ±ÅŸtÄ±r' butonuna basÄ±n.</pre>
            </div>
        </section>

    </div>

    <style>
        .quick-cmd-btn {
            @apply text-sm px-4 py-2 rounded-full border border-[#D7BB56]/50 text-[#D7BB56] hover:bg-[#D7BB56]/10 transition-all duration-200;
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id === 'undefined' ? 'default-app-id' : __app_id;
        const firebaseConfig = typeof __firebase_config === 'undefined' ? null : JSON.parse(__firebase_config);
        const initialAuthToken = typeof __initial_auth_token === 'undefined' ? null : __initial_auth_token;

        let db, auth, userId;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                globalThis.db = db;
                globalThis.auth = auth;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        globalThis.userId = userId;
                    } else {
                        try {
                            if (initialAuthToken) {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                userId = userCredential.user.uid;
                                console.log("Custom Token Sign-In. User ID:", userId);
                            } else {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Anonymous Sign-In. User ID:", userId);
                            }
                            globalThis.userId = userId;
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            userId = crypto.randomUUID();
                            globalThis.userId = userId;
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }
    </script>
    
    <script>
        // ==========================================
        // BE MY CODE - Ana Uygulama ModÃ¼lÃ¼
        // ==========================================

        const App = (() => {
            // KonfigÃ¼rasyon
            const CONFIG = {
                GEMINI_API_KEY: "AIzaSyCMAcbLrhsR8EqUfOgr7SmKTvPTeQU0ZkQ",
                TEXT_MODEL: 'gemini-2.5-flash-preview-09-2025',
                TTS_MODEL: 'gemini-2.5-flash-preview-tts',
                SYSTEM_PROMPT: String.raw`Sen gÃ¶rme engelli bir Ã¶ÄŸrenci iÃ§in Ã§alÄ±ÅŸan, sadece saf Python kodlarÄ± Ã¼reten bir asistansÄ±n. KodlarÄ± aÃ§Ä±klama, yorum veya ek metin olmadan, sadece kod bloÄŸu olarak dÃ¶ndÃ¼r. KullanÄ±cÄ±nÄ±n komutunu Python 3.8+ uyumlu kodla yerine getir. Ã–rneÄŸin, 'for dÃ¶ngÃ¼sÃ¼ yaz' komutuna karÅŸÄ±lÄ±k 'for i in range(10):\n    print(i)' gibi yanÄ±t ver. CevabÄ±n tamamen saf Python kodu olmalÄ±dÄ±r.`,
                DEFAULT_CODE: "# Sesli komutunuzu bekliyorum: 'for dÃ¶ngÃ¼sÃ¼ yaz' veya 'print yaz'"
            };

            // State
            const state = {
                editor: null,
                recognition: null,
                isListening: false
            };

            // DOM Elements
            const elements = {
                statusMessage: document.getElementById('statusMessage'),
                ttsStatus: document.getElementById('ttsStatus'),
                voiceCommandBtn: document.getElementById('voiceCommandBtn'),
                terminalOutput: document.getElementById('terminalOutput'),
                micIcon: document.getElementById('micIcon'),
                loaderIcon: document.getElementById('loaderIcon'),
                runCodeBtn: document.getElementById('runCodeBtn')
            };

            // ==========================================
            // YardÄ±mcÄ± Fonksiyonlar
            // ==========================================

            const Utils = {
                base64ToArrayBuffer(base64) {
                    const binaryString = globalThis.atob(base64);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.codePointAt(i);
                    }
                    return bytes.buffer;
                },

                writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.codePointAt(i));
                    }
                },

                pcmToWav(pcm16, sampleRate) {
                    const numChannels = 1;
                    const bytesPerSample = 2;
                    const blockAlign = numChannels * bytesPerSample;
                    const byteRate = sampleRate * blockAlign;
                    const dataSize = pcm16.length * bytesPerSample;
                    const buffer = new ArrayBuffer(44 + dataSize);
                    const view = new DataView(buffer);

                    let offset = 0;

                    this.writeString(view, offset, 'RIFF'); offset += 4;
                    view.setUint32(offset, 36 + dataSize, true); offset += 4;
                    this.writeString(view, offset, 'WAVE'); offset += 4;

                    this.writeString(view, offset, 'fmt '); offset += 4;
                    view.setUint32(offset, 16, true); offset += 4;
                    view.setUint16(offset, 1, true); offset += 2;
                    view.setUint16(offset, numChannels, true); offset += 2;
                    view.setUint32(offset, sampleRate, true); offset += 4;
                    view.setUint32(offset, byteRate, true); offset += 4;
                    view.setUint16(offset, blockAlign, true); offset += 2;
                    view.setUint16(offset, 16, true); offset += 2;

                    this.writeString(view, offset, 'data'); offset += 4;
                    view.setUint32(offset, dataSize, true);

                    const pcmBytes = new Uint8Array(buffer, 44);
                    const pcmView = new DataView(pcmBytes.buffer);
                    for (let i = 0; i < pcm16.length; i++) {
                        pcmView.setInt16(i * bytesPerSample, pcm16[i], true);
                    }

                    return new Blob([buffer], { type: 'audio/wav' });
                },

                async fetchWithRetry(url, options, maxRetries = 5) {
                    for (let i = 0; i < maxRetries; i++) {
                        try {
                            const response = await fetch(url, options);
                            if (response.ok) {
                                return response;
                            } else if (response.status === 429 && i < maxRetries - 1) {
                                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                                console.warn(`API Rate Limit. Retrying in ${Math.round(delay / 1000)}s...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                            } else {
                                throw new Error(`API Error: HTTP ${response.status} - ${response.statusText}`);
                            }
                        } catch (error) {
                            if (i === maxRetries - 1) throw error;
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            console.error(`Fetch Error: ${error.message}. Retrying in ${Math.round(delay / 1000)}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
            };

            // ==========================================
            // UI YÃ¶netimi
            // ==========================================

            const UI = {
                setStatus(message, isLoading = false, isError = false) {
                    elements.statusMessage.textContent = message;
                    elements.statusMessage.classList.remove('text-gray-300', 'text-red-500', 'accent-color');
                    elements.micIcon.classList.toggle('hidden', isLoading);
                    elements.loaderIcon.classList.toggle('hidden', !isLoading);
                    
                    if (isError) {
                        elements.statusMessage.classList.add('text-red-500');
                    } else if (isLoading) {
                        elements.statusMessage.classList.add('accent-color');
                    } else {
                        elements.statusMessage.classList.add('text-gray-300');
                    }
                },

                setTTSStatus(message, isActive = false) {
                    elements.ttsStatus.textContent = message;
                    elements.ttsStatus.classList.toggle('accent-color', isActive);
                    elements.ttsStatus.classList.toggle('text-gray-500', !isActive);
                },

                updateTerminal(output) {
                    elements.terminalOutput.textContent = output;
                },

                appendTerminal(output) {
                    elements.terminalOutput.textContent += output;
                }
            };

            // ==========================================
            // Gemini API Ä°ÅŸlemleri
            // ==========================================

            const GeminiAPI = {
                async generateCode(prompt) {
                    // API anahtarÄ± kontrolÃ¼
                    if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY === "") {
                        const errorMsg = "Gemini API anahtarÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. LÃ¼tfen API anahtarÄ±nÄ±zÄ± ekleyin.";
                        UI.setStatus(`HATA: ${errorMsg}`, false, true);
                        await this.speak("API anahtarÄ± bulunamadÄ±. LÃ¼tfen kodda GEMINI_API_KEY deÄŸerini ayarlayÄ±n.");
                        return null;
                    }

                    UI.setStatus('Kod Ã¼retiliyor...', true);
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.TEXT_MODEL}:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: CONFIG.SYSTEM_PROMPT }] },
                        config: { temperature: 0.1 }
                    };

                    try {
                        const response = await Utils.fetchWithRetry(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await response.json();
                        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (generatedText) {
                            UI.setStatus('Kod baÅŸarÄ±yla oluÅŸturuldu.', false);
                            return generatedText.trim();
                        } else {
                            throw new Error("API'den geÃ§erli kod yanÄ±tÄ± alÄ±namadÄ±.");
                        }
                    } catch (error) {
                        console.error("Code Generation Error:", error);
                        UI.setStatus(`HATA: Kod Ã¼retilemedi. ${error.message}`, false, true);
                        await this.speak(`ÃœzgÃ¼nÃ¼m, kod Ã¼retilirken bir hata oluÅŸtu.`);
                        return null;
                    }
                },

                async speak(text, voiceName = "Kore") {
                    if (!text || text.length === 0) return;
                    
                    // API anahtarÄ± kontrolÃ¼ - TTS iÃ§in
                    if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY === "") {
                        console.warn("Gemini API anahtarÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. TTS devre dÄ±ÅŸÄ±.");
                        UI.setTTSStatus("API anahtarÄ± eksik - Ses Ã¶zelliÄŸi devre dÄ±ÅŸÄ±", false);
                        return;
                    }
                    
                    UI.setTTSStatus("Sesli geri bildirim oluÅŸturuluyor...", true);
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.TTS_MODEL}:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: voiceName }
                                }
                            }
                        }
                    };
                    
                    try {
                        const response = await Utils.fetchWithRetry(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType?.startsWith("audio/")) {
                            const match = mimeType.match(/rate=(\d+)/);
                            const sampleRate = match ? Number.parseInt(match[1], 10) : 24000;
                            
                            const pcmData = Utils.base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = Utils.pcmToWav(pcm16, sampleRate);
                            const audioUrl = URL.createObjectURL(wavBlob);
                            
                            const audio = new Audio(audioUrl);
                            
                            await new Promise((resolve) => {
                                audio.onended = () => {
                                    URL.revokeObjectURL(audioUrl);
                                    resolve();
                                };
                                audio.onerror = (e) => {
                                    console.error("Audio playback error:", e);
                                    UI.setTTSStatus("Ses Ã§alÄ±nÄ±rken hata oluÅŸtu.");
                                    URL.revokeObjectURL(audioUrl);
                                    resolve();
                                };
                                
                                // Ses Ã§alma denemesi
                                audio.play().catch(e => {
                                    console.error("Audio play error:", e);
                                    
                                    // KullanÄ±cÄ± etkileÅŸimi gerekiyorsa
                                    if (e.name === 'NotAllowedError') {
                                        UI.setTTSStatus("Ses Ã§alma izni gerekli. LÃ¼tfen sayfayla etkileÅŸimde bulunun.");
                                        console.warn('Ses Ã§almak iÃ§in kullanÄ±cÄ± etkileÅŸimi gerekli. Butona tÄ±klayÄ±n veya klavye kullanÄ±n.');
                                    } else {
                                        UI.setTTSStatus("Ses Ã§alma hatasÄ±: " + e.message);
                                    }
                                    URL.revokeObjectURL(audioUrl);
                                    resolve();
                                });
                            });
                        } else {
                            console.error("TTS API'den ses verisi alÄ±namadÄ±.");
                            UI.setTTSStatus("Ses verisi boÅŸ geldi.");
                        }
                    } catch (error) {
                        console.error("TTS API Error:", error);
                        UI.setTTSStatus(`TTS HatasÄ±: ${error.message}`);
                    } finally {
                        UI.setTTSStatus("Sesli geri bildirim hazÄ±r", false);
                    }
                }
            };

            // ==========================================
            // Kod Ä°ÅŸlemleri
            // ==========================================

            const CodeHandler = {
                speakCode(code) {
                    if (!code || code.trim() === "") {
                        GeminiAPI.speak("EditÃ¶rde okunacak kod bulunmamaktadÄ±r.");
                        return;
                    }
                    
                    let speakableCode = code
                        .replaceAll(/\n/g, ". Yeni SatÄ±r. ")
                        .replaceAll(/#/g, "Yorum. ")
                        .replaceAll(/=/g, " eÅŸittir ")
                        .replaceAll(/!=/g, " eÅŸit deÄŸildir ")
                        .replaceAll(/==/g, " eÅŸittir ")
                        .replaceAll(/:/g, ". Ä°ki nokta. ")
                        .replaceAll(/\(/g, " parantez aÃ§ ")
                        .replaceAll(/\)/g, " parantez kapat ")
                        .replaceAll(/\[/g, " kÃ¶ÅŸeli parantez aÃ§ ")
                        .replaceAll(/\]/g, " kÃ¶ÅŸeli parantez kapat ")
                        .replaceAll(/'/g, " tÄ±rnak ")
                        .replaceAll(/"/g, " Ã§ift tÄ±rnak ");

                    GeminiAPI.speak(`Åžu anki kod: ${speakableCode}`);
                },

                runSimulatedCode() {
                    const code = state.editor.getValue();
                    UI.updateTerminal(`>>> KOD Ã‡ALIÅžTIRILIYOR...\n`);
                    GeminiAPI.speak("Kod Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor. LÃ¼tfen terminal Ã§Ä±ktÄ±sÄ±nÄ± bekleyin.");
                    
                    try {
                        const printMatches = [...code.matchAll(/print\s*\((.*?)\)/g)];
                        
                        let simulatedOutput = "";
                        if (printMatches.length > 0) {
                            simulatedOutput += ">>> SimÃ¼le EdilmiÅŸ Ã‡Ä±ktÄ±:\n";
                            printMatches.forEach((match) => {
                                let content = match[1].trim().replace(/['"]/g, '');
                                if (content.startsWith('f')) content = content.substring(1);
                                if (content.length > 50) content = content.substring(0, 50) + "... (kesildi)";
                                simulatedOutput += `${content}\n`;
                            });
                        } else {
                            simulatedOutput += ">>> Kodda 'print' ifadesi bulunamadÄ±. Ã‡Ä±ktÄ± yok.\n";
                        }
                        
                        UI.appendTerminal(simulatedOutput);
                        GeminiAPI.speak("Kod Ã§alÄ±ÅŸtÄ±rma simÃ¼lasyonu tamamlandÄ±. Terminal Ã§Ä±ktÄ±sÄ± hazÄ±rdÄ±r.");
                    } catch (e) {
                        UI.appendTerminal(`HATA: SimÃ¼lasyon sÄ±rasÄ±nda hata oluÅŸtu. ${e.message}`);
                        GeminiAPI.speak("SimÃ¼lasyon hatasÄ± oluÅŸtu. Kodunuzda bir problem olabilir.");
                    }
                }
            };

            // ==========================================
            // Ses TanÄ±ma
            // ==========================================

            const VoiceRecognition = {
                setup() {
                    // TarayÄ±cÄ± kontrolÃ¼
                    if (!('webkitSpeechRecognition' in globalThis)) {
                        const errorMsg = "HATA: TarayÄ±cÄ±nÄ±z Web Speech API'yi desteklemiyor. LÃ¼tfen Chrome veya Edge kullanÄ±n.";
                        UI.setStatus(errorMsg, false, true);
                        elements.voiceCommandBtn.disabled = true;
                        console.error(errorMsg);
                        return;
                    }

                    // HTTPS kontrolÃ¼
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                        console.warn('âš ï¸ GÃ¼venlik uyarÄ±sÄ±: Mikrofon eriÅŸimi iÃ§in HTTPS Ã¶nerilir.');
                    }

                    state.recognition = new webkitSpeechRecognition();
                    state.recognition.continuous = false;
                    state.recognition.interimResults = false;
                    state.recognition.lang = 'tr-TR';
                    
                    state.recognition.onstart = () => {
                        state.isListening = true;
                        elements.voiceCommandBtn.classList.add('listening');
                        UI.setStatus('ðŸŽ¤ Dinleniyor... LÃ¼tfen konuÅŸun.', false);
                        console.log('Mikrofon aktif - Dinleme baÅŸladÄ±');
                    };
                    
                    state.recognition.onend = () => {
                        state.isListening = false;
                        elements.voiceCommandBtn.classList.remove('listening');
                        UI.setStatus('Mikrofon kapalÄ±. Tekrar tÄ±klayÄ±n (Ctrl+M).', false);
                        console.log('Dinleme sona erdi');
                    };
                    
                    state.recognition.onerror = (event) => {
                        state.isListening = false;
                        elements.voiceCommandBtn.classList.remove('listening');
                        console.error('Speech Recognition Error:', event.error);
                        
                        let errorMsg = '';
                        switch(event.error) {
                            case 'not-allowed':
                            case 'permission-denied':
                                errorMsg = 'Mikrofon izni reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan mikrofon eriÅŸimine izin verin.';
                                break;
                            case 'no-speech':
                                errorMsg = 'Ses algÄ±lanamadÄ±. LÃ¼tfen tekrar deneyin.';
                                break;
                            case 'audio-capture':
                                errorMsg = 'Mikrofon bulunamadÄ± veya kullanÄ±labilir deÄŸil.';
                                break;
                            case 'network':
                                errorMsg = 'AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.';
                                break;
                            case 'aborted':
                                errorMsg = 'Dinleme iptal edildi.';
                                break;
                            default:
                                errorMsg = `Ses tanÄ±ma hatasÄ±: ${event.error}`;
                        }
                        
                        UI.setStatus(errorMsg, false, true);
                        console.error('Hata detayÄ±:', errorMsg);
                    };
                    
                    state.recognition.onresult = async (event) => {
                        const transcript = event.results[0][0].transcript;
                        const confidence = event.results[0][0].confidence;
                        
                        console.log('TanÄ±nan metin:', transcript, '| GÃ¼ven skoru:', confidence);
                        UI.setStatus(`âœ“ TanÄ±nan: "${transcript}"`, false);
                        
                        if (transcript.toLowerCase().includes("kodu sesli oku") || transcript.toLowerCase().includes("kodu oku")) {
                            CodeHandler.speakCode(state.editor.getValue());
                        } else if (transcript.toLowerCase().includes("kodu Ã§alÄ±ÅŸtÄ±r") || transcript.toLowerCase().includes("Ã§alÄ±ÅŸtÄ±r")) {
                            CodeHandler.runSimulatedCode();
                        } else {
                            const code = await GeminiAPI.generateCode(transcript);
                            if (code) {
                                state.editor.setValue(state.editor.getValue().trim() + "\n" + code);
                                state.editor.refresh();
                                GeminiAPI.speak(`Kodunuz baÅŸarÄ±yla eklendi.`);
                            }
                        }
                    };

                    console.log('âœ“ Ses tanÄ±ma sistemi hazÄ±r');
                },

                toggle() {
                    if (!state.recognition) {
                        UI.setStatus('Ses tanÄ±ma baÅŸlatÄ±lamadÄ±.', false, true);
                        return;
                    }

                    if (state.isListening) {
                        state.recognition.stop();
                        console.log('KullanÄ±cÄ± dinlemeyi durdurdu');
                    } else {
                        try {
                            state.recognition.start();
                            console.log('Mikrofon baÅŸlatÄ±lÄ±yor...');
                        } catch (error) {
                            console.error('Mikrofon baÅŸlatma hatasÄ±:', error);
                            UI.setStatus('Mikrofon baÅŸlatÄ±lamadÄ±. SayfayÄ± yenileyin ve tekrar deneyin.', false, true);
                        }
                    }
                }
            };

            // ==========================================
            // BaÅŸlatma
            // ==========================================

            function init() {
                const codeEditorElement = document.getElementById('codeEditor');
                state.editor = CodeMirror.fromTextArea(codeEditorElement, {
                    lineNumbers: true,
                    mode: "python",
                    theme: "monokai",
                    indentUnit: 4,
                    tabSize: 4,
                    extraKeys: {
                        "Ctrl-M": () => VoiceRecognition.toggle(),
                        "Cmd-M": () => VoiceRecognition.toggle(),
                        "F5": () => CodeHandler.runSimulatedCode(),
                        "Ctrl-R": () => CodeHandler.speakCode(state.editor.getValue()),
                    }
                });
                state.editor.setValue(CONFIG.DEFAULT_CODE);
                globalThis.editor = state.editor;

                elements.voiceCommandBtn.addEventListener('click', () => VoiceRecognition.toggle());
                elements.runCodeBtn.addEventListener('click', () => CodeHandler.runSimulatedCode());
                
                VoiceRecognition.setup();

                // API anahtarÄ± kontrolÃ¼ ve uyarÄ±
                if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY === "") {
                    UI.setStatus('âš ï¸ API anahtarÄ± eksik - AI Ã¶zellikleri devre dÄ±ÅŸÄ±', false, true);
                    UI.setTTSStatus('API anahtarÄ± yapÄ±landÄ±rÄ±lmadÄ±', false);
                    console.warn('%câš ï¸ GEMINI API ANAHTARI EKSÄ°K', 'color: #D7BB56; font-size: 16px; font-weight: bold;');
                    console.warn('Kod Ã¼retme ve sesli geri bildirim Ã¶zellikleri iÃ§in Gemini API anahtarÄ± gereklidir.');
                    console.warn('API anahtarÄ±nÄ± CONFIG.GEMINI_API_KEY deÄŸiÅŸkenine ekleyin.');
                }
            }

            // ==========================================
            // Keyboard Shortcuts
            // ==========================================

            function setupKeyboardShortcuts() {
                document.addEventListener('keydown', (event) => {
                    if ((event.ctrlKey || event.metaKey) && event.key === 'm') {
                        event.preventDefault();
                        VoiceRecognition.toggle();
                    }
                    if (event.key === 'F5') {
                        event.preventDefault();
                        CodeHandler.runSimulatedCode();
                    }
                    if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                        event.preventDefault();
                        CodeHandler.speakCode(state.editor.getValue());
                    }
                });
            }

            // ==========================================
            // Public API
            // ==========================================

            return {
                init,
                setupKeyboardShortcuts,
                simulateCommand: async (command) => {
                    if (command.toLowerCase().includes("kodu oku")) {
                        CodeHandler.speakCode(state.editor.getValue());
                    } else {
                        UI.setStatus(`SimÃ¼le Komut: "${command}" - Kod Ã¼retiliyor...`, true);
                        const code = await GeminiAPI.generateCode(command);
                        if (code) {
                            state.editor.setValue(state.editor.getValue().trim() + "\n\n" + code);
                            state.editor.refresh();
                            GeminiAPI.speak(`Kodunuz baÅŸarÄ±yla eklendi.`);
                        }
                    }
                }
            };
        })();

        // ==========================================
        // Uygulama BaÅŸlat
        // ==========================================

        globalThis.onload = () => {
            App.init();
            App.setupKeyboardShortcuts();
        };

        globalThis.App = App;
        
    </script>
</body>
</html>